{% extends "base.html" %}

{% block title %}Map Visualization - MemberSync{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .map-container {
        position: relative;
        margin: 20px 0;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .location-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .location-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .location-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-right: 5px;
    }
    
    .badge-members {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-checkins {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .leaflet-popup-content {
        min-width: 250px;
    }
    
    .popup-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
    }
    
    .popup-info {
        margin: 8px 0;
        font-size: 0.9rem;
    }
    
    .popup-info i {
        width: 20px;
        color: #667eea;
    }
    
    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .legend-title {
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-map-marked-alt"></i> Location Map Visualization</h2>
            <p class="text-muted">Interactive map showing member distribution across locations</p>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="stats-card">
                <div class="row">
                    <div class="col-md-4 stat-item">
                        <div class="stat-number">{{ stats[0] }}</div>
                        <div class="stat-label">üìç Total Locations</div>
                    </div>
                    <div class="col-md-4 stat-item">
                        <div class="stat-number">{{ stats[1] }}</div>
                        <div class="stat-label">üë• Total Members</div>
                    </div>
                    <div class="col-md-4 stat-item">
                        <div class="stat-number">{{ stats[2] }}</div>
                        <div class="stat-label">‚úÖ Active Members</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Organization Filter (for Global Superadmin) -->
    {% if is_global_superadmin and organizations %}
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('map_visualization') }}">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label for="org_filter">Filter by Organization:</label>
                                <select name="org_id" id="org_filter" class="form-control">
                                    <option value="">All Organizations</option>
                                    {% for org in organizations %}
                                    <option value="{{ org[0] }}">{{ org[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Apply Filter
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Map -->
    <div class="row">
        <div class="col-md-9">
            <div class="card">
                <div class="card-body p-0">
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Location List -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Locations</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if locations %}
                        {% for location in locations %}
                        <div class="location-card" onclick="focusLocation({{ loop.index0 }})">
                            <h6 class="mb-2">{{ location.name }}</h6>
                            <p class="text-muted mb-2" style="font-size: 0.85rem;">
                                <i class="fas fa-map-marker-alt"></i> {{ location.city }}, {{ location.state }}
                            </p>
                            <div>
                                <span class="location-badge badge-members">
                                    <i class="fas fa-users"></i> {{ location.member_count }} members
                                </span>
                                <span class="location-badge badge-checkins">
                                    <i class="fas fa-check-circle"></i> {{ location.today_checkins }} today
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted">No locations found</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // Cameroon major cities coordinates (you can expand this)
    const cameroonCities = {
        'Yaound√©': [3.8480, 11.5021],
        'Douala': [4.0511, 9.7679],
        'Garoua': [9.3017, 13.3960],
        'Bamenda': [5.9597, 10.1453],
        'Maroua': [10.5908, 14.3170],
        'Bafoussam': [5.4781, 10.4177],
        'Ngaound√©r√©': [7.3167, 13.5833],
        'Bertoua': [4.5769, 13.6843],
        'Limbe': [4.0232, 9.2065],
        'Buea': [4.1560, 9.2320],
        'Kribi': [2.9372, 9.9085],
        'Ebolowa': [2.9004, 11.1547]
    };
    
    // Initialize map centered on Cameroon
    const map = L.map('map').setView([7.3697, 12.3547], 6);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    // Create marker cluster group
    const markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    
    // Location data from Flask
    const locations = {{ locations | tojson }};
    
    // Store markers for focusing
    window.locationMarkers = [];
    
    // Add markers for each location
    locations.forEach((location, index) => {
        // Try to get coordinates from city name
        let coords = cameroonCities[location.city] || 
                     cameroonCities[location.state] ||
                     [7.3697 + (Math.random() - 0.5) * 4, 12.3547 + (Math.random() - 0.5) * 6];
        
        // Create marker with custom icon based on member count
        const memberCount = location.member_count;
        let markerColor = '#28a745'; // Green for low
        if (memberCount > 100) markerColor = '#dc3545'; // Red for high
        else if (memberCount > 50) markerColor = '#ffc107'; // Yellow for medium
        
        const marker = L.circleMarker(coords, {
            radius: Math.min(8 + memberCount / 10, 25),
            fillColor: markerColor,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.7
        });
        
        // Create popup content
        const popupContent = `
            <div class="popup-title">
                <i class="fas fa-map-marker-alt"></i> ${location.name}
            </div>
            <div class="popup-info">
                <i class="fas fa-building"></i> <strong>Organization:</strong> ${location.org_name}
            </div>
            <div class="popup-info">
                <i class="fas fa-map-pin"></i> <strong>Location:</strong> ${location.city}, ${location.state}
            </div>
            <div class="popup-info">
                <i class="fas fa-users"></i> <strong>Members:</strong> ${location.member_count} (${location.active_members} active)
            </div>
            <div class="popup-info">
                <i class="fas fa-check-circle"></i> <strong>Check-ins Today:</strong> ${location.today_checkins}
            </div>
            <div class="popup-info">
                <i class="fas fa-chart-line"></i> <strong>Total Check-ins:</strong> ${location.total_checkins}
            </div>
            <hr>
            <a href="/checkin/reports?location_id=${location.id}" class="btn btn-sm btn-primary">
                <i class="fas fa-chart-bar"></i> View Reports
            </a>
        `;
        
        marker.bindPopup(popupContent);
        markers.addLayer(marker);
        window.locationMarkers.push(marker);
    });
    
    // Add markers to map
    map.addLayer(markers);
    
    // Add legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <div class="legend-title">Member Count</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #28a745;"></div>
                <span>0-50 members</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffc107;"></div>
                <span>51-100 members</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>100+ members</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
    
    // Function to focus on a location
    function focusLocation(index) {
        const marker = window.locationMarkers[index];
        if (marker) {
            map.setView(marker.getLatLng(), 12);
            marker.openPopup();
        }
    }
    
    // Add scale control
    L.control.scale().addTo(map);
</script>
{% endblock %}
