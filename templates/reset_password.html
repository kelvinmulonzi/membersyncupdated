{% extends "base.html" %}
{% block title %}Reset Password - MemberSync{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-5 col-lg-4">
        <div class="card shadow">
            <div class="card-header text-center bg-success text-white">
                <h3 class="mb-0">
                    <i class="fas fa-lock"></i>
                    Reset Password
                </h3>
                <p class="mb-0">Create a new secure password</p>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info">
                    <i class="fas fa-user"></i>
                    <strong>Account:</strong> {{ email }}
                    <br>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        You're resetting the password for this account
                    </small>
                </div>

                <form method="POST" id="resetPasswordForm">
                    <input type="hidden" name="token" value="{{ token }}">
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock"></i> New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="password" 
                                   name="password" 
                                   placeholder="Enter new password"
                                   required 
                                   autocomplete="new-password"
                                   minlength="6">
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-shield-alt"></i>
                            Password must be at least 6 characters long
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-lock"></i> Confirm New Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="confirm_password" 
                                   name="confirm_password" 
                                   placeholder="Confirm new password"
                                   required 
                                   autocomplete="new-password">
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="form-text"></div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-check"></i> Update Password
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center">
                <!-- Language Selector -->
                <div class="mb-3">
                    <div class="custom-translate-widget">
                        <select id="custom-language-selector" class="custom-language-selector" onchange="changeLanguageCustom(this.value)">
                            <option value="en" selected>ðŸ‡ºðŸ‡¸ English</option>
                            <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                            <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                        </select>
                    </div>
                </div>
                
                <p class="mb-0 text-muted">
                    <a href="{{ url_for('login') }}" class="text-decoration-none">
                        <i class="fas fa-arrow-left"></i> Back to Login
                    </a>
                </p>
            </div>
        </div>

        <!-- Password Requirements Card -->
        <div class="card mt-4 border-info">
            <div class="card-body">
                <h6 class="card-title text-info">
                    <i class="fas fa-shield-alt"></i>
                    Password Requirements
                </h6>
                <ul class="list-unstyled mb-0" id="passwordRequirements">
                    <li class="mb-2" id="req-length">
                        <i class="fas fa-circle text-secondary"></i>
                        At least 6 characters long
                    </li>
                    <li class="mb-2" id="req-lowercase">
                        <i class="fas fa-circle text-secondary"></i>
                        Contains lowercase letters (a-z)
                    </li>
                    <li class="mb-2" id="req-uppercase">
                        <i class="fas fa-circle text-secondary"></i>
                        Contains uppercase letters (A-Z)
                    </li>
                    <li class="mb-2" id="req-number">
                        <i class="fas fa-circle text-secondary"></i>
                        Contains numbers (0-9)
                    </li>
                    <li class="mb-0" id="req-match">
                        <i class="fas fa-circle text-secondary"></i>
                        Passwords match
                    </li>
                </ul>
            </div>
        </div>

        <!-- Security Tips Card -->
        <div class="card mt-3 border-warning">
            <div class="card-body">
                <h6 class="card-title text-warning">
                    <i class="fas fa-lightbulb"></i>
                    Security Tips
                </h6>
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Use a unique password you haven't used elsewhere
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Consider using a passphrase with special characters
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Don't share your password with anyone
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success"></i>
                        Consider using a password manager
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i>
                    Password Reset Successful
                </h5>
            </div>
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4>Password Updated Successfully!</h4>
                <p class="mb-0">Your password has been changed. You will be redirected to the login page.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <a href="{{ url_for('login') }}" class="btn btn-success">
                    <i class="fas fa-sign-in-alt"></i> Continue to Login
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const passwordMatch = document.getElementById('passwordMatch');
    
    // Password visibility toggles
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        const icon = this.querySelector('i');
        icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
    });
    
    toggleConfirmPassword.addEventListener('click', function() {
        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordInput.setAttribute('type', type);
        
        const icon = this.querySelector('i');
        icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
    });
    
    // Password strength checking
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        checkPasswordRequirements(password);
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
    });
    
    function checkPasswordRequirements(password) {
        const requirements = {
            'req-length': password.length >= 6,
            'req-lowercase': /[a-z]/.test(password),
            'req-uppercase': /[A-Z]/.test(password),
            'req-number': /[0-9]/.test(password)
        };
        
        Object.keys(requirements).forEach(reqId => {
            const element = document.getElementById(reqId);
            const icon = element.querySelector('i');
            
            if (requirements[reqId]) {
                icon.className = 'fas fa-check-circle text-success';
                element.classList.remove('text-muted');
                element.classList.add('text-success');
            } else {
                icon.className = 'fas fa-circle text-secondary';
                element.classList.remove('text-success');
                element.classList.add('text-muted');
            }
        });
        
        // Update password input validation state
        if (password.length > 0) {
            if (password.length >= 6) {
                passwordInput.classList.remove('is-invalid');
                passwordInput.classList.add('is-valid');
            } else {
                passwordInput.classList.remove('is-valid');
                passwordInput.classList.add('is-invalid');
            }
        } else {
            passwordInput.classList.remove('is-valid', 'is-invalid');
        }
        
        updateSubmitButton();
    }
    
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const matchElement = document.getElementById('req-match');
        const matchIcon = matchElement.querySelector('i');
        
        if (confirmPassword.length > 0) {
            if (password === confirmPassword && password.length >= 6) {
                matchIcon.className = 'fas fa-check-circle text-success';
                matchElement.classList.remove('text-muted');
                matchElement.classList.add('text-success');
                
                confirmPasswordInput.classList.remove('is-invalid');
                confirmPasswordInput.classList.add('is-valid');
                
                passwordMatch.innerHTML = '<i class="fas fa-check text-success"></i> Passwords match';
                passwordMatch.className = 'form-text text-success';
            } else {
                matchIcon.className = 'fas fa-times-circle text-danger';
                matchElement.classList.remove('text-muted', 'text-success');
                matchElement.classList.add('text-danger');
                
                confirmPasswordInput.classList.remove('is-valid');
                confirmPasswordInput.classList.add('is-invalid');
                
                passwordMatch.innerHTML = '<i class="fas fa-times text-danger"></i> Passwords do not match';
                passwordMatch.className = 'form-text text-danger';
            }
        } else {
            matchIcon.className = 'fas fa-circle text-secondary';
            matchElement.classList.remove('text-success', 'text-danger');
            matchElement.classList.add('text-muted');
            
            confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
            passwordMatch.innerHTML = '';
        }
        
        updateSubmitButton();
    }
    
    function updateSubmitButton() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        const isValid = password.length >= 6 && 
                       password === confirmPassword && 
                       confirmPassword.length > 0;
        
        submitBtn.disabled = !isValid;
        
        if (isValid) {
            submitBtn.classList.remove('btn-outline-success');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-outline-success');
        }
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Clear previous validation
        let isValid = true;
        
        // Validate password
        if (!password) {
            e.preventDefault();
            passwordInput.classList.add('is-invalid');
            passwordInput.focus();
            isValid = false;
        } else if (password.length < 6) {
            e.preventDefault();
            passwordInput.classList.add('is-invalid');
            passwordInput.focus();
            isValid = false;
        }
        
        // Validate password confirmation
        if (!confirmPassword) {
            e.preventDefault();
            confirmPasswordInput.classList.add('is-invalid');
            if (isValid) confirmPasswordInput.focus();
            isValid = false;
        } else if (password !== confirmPassword) {
            e.preventDefault();
            confirmPasswordInput.classList.add('is-invalid');
            if (isValid) confirmPasswordInput.focus();
            isValid = false;
        }
        
        if (isValid) {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating Password...';
        }
    });
    
    // Initialize button state
    updateSubmitButton();
    
    // Focus on password field
    passwordInput.focus();
});
</script>
{% endblock %}
